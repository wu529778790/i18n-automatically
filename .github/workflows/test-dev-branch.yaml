name: Dev Branch Tests

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run ESLint
        run: yarn lint

      - name: Run VS Code Extension Tests
        run: yarn test

      - name: Validate demo test files
        run: |
          echo "éªŒè¯æµ‹è¯•ç¤ºä¾‹æ–‡ä»¶..."

          # æ£€æŸ¥å¿…è¦çš„æµ‹è¯•æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          files=(
            "tests/fixtures/i18n-samples/tsx/before.tsx"
            "tests/fixtures/i18n-samples/tsx/after.tsx"
            "tests/fixtures/i18n-samples/ts/before.ts"
            "tests/fixtures/i18n-samples/ts/after.ts"
            "tests/fixtures/i18n-samples/jsx/before.jsx"
            "tests/fixtures/i18n-samples/jsx/after.jsx"
            "tests/fixtures/i18n-samples/js/before.js"
            "tests/fixtures/i18n-samples/js/after.js"
            "tests/fixtures/i18n-samples/vue/before.vue"
            "tests/fixtures/i18n-samples/vue/after.vue"
          )

          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file å­˜åœ¨"
            else
              echo "âŒ $file ä¸å­˜åœ¨"
              exit 1
            fi
          done

          echo "âœ… æ‰€æœ‰æµ‹è¯•ç¤ºä¾‹æ–‡ä»¶éªŒè¯é€šè¿‡"

      - name: Test configuration file
        run: |
          echo "éªŒè¯é…ç½®æ–‡ä»¶..."
          if [ -f "tests/fixtures/automatically-i18n-config.json" ]; then
            echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨"
            # éªŒè¯JSONæ ¼å¼æ˜¯å¦æ­£ç¡®
            if node -e "JSON.parse(require('fs').readFileSync('tests/fixtures/automatically-i18n-config.json', 'utf8'))"; then
              echo "âœ… é…ç½®æ–‡ä»¶JSONæ ¼å¼æ­£ç¡®"
            else
              echo "âŒ é…ç½®æ–‡ä»¶JSONæ ¼å¼é”™è¯¯"
              exit 1
            fi
          else
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

      - name: Run unit tests
        run: |
          echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
          # è¿è¡Œtests/unitç›®å½•ä¸­çš„å…·ä½“æµ‹è¯•æ–‡ä»¶
          if [ -f "tests/unit/jsProcessor.test.js" ]; then
            echo "âœ… æ‰¾åˆ°JSå¤„ç†å™¨æµ‹è¯•æ–‡ä»¶"
            node tests/unit/jsProcessor.test.js || echo "JSå¤„ç†å™¨æµ‹è¯•éœ€è¦å®Œå–„"
          fi

          if [ -f "tests/unit/vueProcessor.test.js" ]; then
            echo "âœ… æ‰¾åˆ°Vueå¤„ç†å™¨æµ‹è¯•æ–‡ä»¶"
            node tests/unit/vueProcessor.test.js || echo "Vueå¤„ç†å™¨æµ‹è¯•éœ€è¦å®Œå–„"
          fi

      - name: Run fixtures validation
        run: |
          echo "è¿è¡Œæµ‹è¯•ç”¨ä¾‹ä¸“é¡¹éªŒè¯..."
          node tests/unit/demoTest.validation.js

      - name: Test build process
        run: |
          echo "æµ‹è¯•æ‰©å±•æ‰“åŒ…è¿‡ç¨‹..."
          # å®‰è£…vsceç”¨äºæµ‹è¯•æ‰“åŒ…
          npm install -g @vscode/vsce

          # å°è¯•æ‰“åŒ…æ‰©å±•ï¼ˆä¸å‘å¸ƒï¼‰
          vsce package --out test-extension.vsix

          if [ -f "test-extension.vsix" ]; then
            echo "âœ… æ‰©å±•æ‰“åŒ…æˆåŠŸ"
            # æ¸…ç†æµ‹è¯•æ–‡ä»¶
            rm test-extension.vsix
          else
            echo "âŒ æ‰©å±•æ‰“åŒ…å¤±è´¥"
            exit 1
          fi

      - name: Test Summary
        if: always()
        run: |
          echo "ğŸ‰ Devåˆ†æ”¯æµ‹è¯•å®Œæˆ!"
          echo "åŒ…å«çš„æµ‹è¯•å†…å®¹ï¼š"
          echo "  âœ… ESLintä»£ç æ£€æŸ¥"
          echo "  âœ… VS Codeæ‰©å±•æµ‹è¯•"
          echo "  âœ… Demoæµ‹è¯•æ–‡ä»¶éªŒè¯"
          echo "  âœ… é…ç½®æ–‡ä»¶éªŒè¯"
          echo "  âœ… å•å…ƒæµ‹è¯•æ‰§è¡Œ"
          echo "  âœ… æ‰©å±•æ‰“åŒ…æµ‹è¯•"
