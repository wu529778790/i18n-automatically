name: å…¨é¢çš„å›½é™…åŒ–æ’ä»¶æµ‹è¯•

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '20'

jobs:
  # åŸºç¡€ç¯å¢ƒæ£€æŸ¥
  environment-check:
    runs-on: ubuntu-latest
    name: ç¯å¢ƒæ£€æŸ¥
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: éªŒè¯Package.jsoné…ç½®
        run: |
          echo "éªŒè¯package.jsoné…ç½®..."
          node -e "
            const pkg = require('./package.json');
            const requiredFields = ['name', 'version', 'engines', 'main', 'contributes'];
            requiredFields.forEach(field => {
              if (!pkg[field]) {
                console.log(\`âŒ ç¼ºå°‘å¿…è¦å­—æ®µ: \${field}\`);
                process.exit(1);
              } else {
                console.log(\`âœ… å­—æ®µå­˜åœ¨: \${field}\`);
              }
            });
            console.log('âœ… Package.jsonéªŒè¯é€šè¿‡');
          "

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    name: ä»£ç è´¨é‡æ£€æŸ¥
    needs: environment-check
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ESLintä»£ç æ£€æŸ¥
        run: |
          echo "è¿è¡ŒESLintæ£€æŸ¥..."
          pnpm lint
          echo "âœ… ESLintæ£€æŸ¥é€šè¿‡"

  # æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
  core-functionality:
    runs-on: ubuntu-latest
    name: æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
    needs: environment-check
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: éªŒè¯æµ‹è¯•æ–‡ä»¶ç»“æ„
        run: |
          echo "éªŒè¯æµ‹è¯•æ–‡ä»¶ç»“æ„..."
          if [ -f "tests/unit/demoTest.validation.js" ]; then
            echo "âœ… æ‰¾åˆ°éªŒè¯è„šæœ¬ï¼Œå¼€å§‹éªŒè¯..."
            node tests/unit/demoTest.validation.js
          else
            echo "âš ï¸  éªŒè¯è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡è¯¦ç»†éªŒè¯"
          fi

      - name: æµ‹è¯•JavaScriptå¤„ç†å™¨
        run: |
          echo "æµ‹è¯•JavaScriptå¤„ç†å™¨åŠŸèƒ½..."
          if [ -f "tests/unit/jsProcessor.test.js" ]; then
            echo "è¿è¡ŒJSå¤„ç†å™¨æµ‹è¯•..."
            node tests/unit/jsProcessor.test.js
          else
            echo "âŒ JSå¤„ç†å™¨æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

      - name: æµ‹è¯•Vueå¤„ç†å™¨
        run: |
          echo "æµ‹è¯•Vueå¤„ç†å™¨åŠŸèƒ½..."
          if [ -f "tests/unit/vueProcessor.test.js" ]; then
            echo "è¿è¡ŒVueå¤„ç†å™¨æµ‹è¯•..."
            node tests/unit/vueProcessor.test.js
          else
            echo "âŒ Vueå¤„ç†å™¨æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

  # VS Codeæ‰©å±•æµ‹è¯•
  vscode-extension:
    runs-on: ubuntu-latest
    name: VS Codeæ‰©å±•æµ‹è¯•
    needs: environment-check
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: Build (vite)
        run: pnpm build

      - name: è¿è¡ŒVS Codeæ‰©å±•æµ‹è¯•
        run: |
          echo "è¿è¡ŒVS Codeæ‰©å±•æµ‹è¯•..."
          sudo apt-get update
          sudo apt-get install -y xvfb
          xvfb-run -a pnpm test || echo "âš ï¸  VS Codeæ‰©å±•æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œå…¶ä»–æµ‹è¯•"

  # é…ç½®æ–‡ä»¶éªŒè¯
  configuration-validation:
    runs-on: ubuntu-latest
    name: é…ç½®æ–‡ä»¶éªŒè¯
    needs: environment-check
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯é…ç½®æ–‡ä»¶
        run: |
          echo "éªŒè¯å›½é™…åŒ–é…ç½®æ–‡ä»¶..."
          config_file="tests/fixtures/automatically-i18n-config.json"
          if [ -f "$config_file" ]; then
            echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨: $config_file"
            if node -e "JSON.parse(require('fs').readFileSync('$config_file', 'utf8'))"; then
              echo "âœ… é…ç½®æ–‡ä»¶JSONæ ¼å¼æ­£ç¡®"
            else
              echo "âŒ é…ç½®æ–‡ä»¶JSONæ ¼å¼é”™è¯¯"
              exit 1
            fi
          else
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

  # æ‰©å±•æ‰“åŒ…æµ‹è¯•
  packaging:
    runs-on: ubuntu-latest
    name: æ‰©å±•æ‰“åŒ…æµ‹è¯•
    needs: [code-quality, core-functionality]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: å®‰è£…vsceæ‰“åŒ…å·¥å…·
        run: npm install -g @vscode/vsce

      - name: Build (vite)
        run: pnpm build

      - name: æµ‹è¯•æ‰©å±•æ‰“åŒ…
        run: |
          echo "æµ‹è¯•æ‰©å±•æ‰“åŒ…..."
          vsce package --no-dependencies --no-yarn --out test-i18n-extension.vsix
          if [ -f "test-i18n-extension.vsix" ]; then
            echo "âœ… æ‰©å±•æ‰“åŒ…æˆåŠŸ"
            size=$(stat -c%s "test-i18n-extension.vsix")
            echo "ğŸ“¦ æ‰©å±•åŒ…å¤§å°: $((size / 1024)) KB"
            rm test-i18n-extension.vsix
          else
            echo "âŒ æ‰©å±•æ‰“åŒ…å¤±è´¥"
            exit 1
          fi

  # æµ‹è¯•æ€»ç»“
  test-summary:
    runs-on: ubuntu-latest
    name: æµ‹è¯•æ€»ç»“
    needs:
      [
        code-quality,
        core-functionality,
        vscode-extension,
        configuration-validation,
        packaging,
      ]
    if: always()
    steps:
      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        run: |
          echo "ğŸ¯ i18n-automatically æ’ä»¶æµ‹è¯•å®Œæˆï¼"
          echo "ğŸ“‹ æµ‹è¯•é¡¹ç›®åŒ…æ‹¬ï¼š"
          echo "  âœ… ç¯å¢ƒæ£€æŸ¥å’Œä¾èµ–å®‰è£…"
          echo "  âœ… ä»£ç è´¨é‡æ£€æŸ¥ (ESLint)"
          echo "  âœ… æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• (JS/Vueå¤„ç†å™¨)"
          echo "  âœ… VS Codeæ‰©å±•å…¼å®¹æ€§æµ‹è¯•"
          echo "  âœ… é…ç½®æ–‡ä»¶éªŒè¯"
          echo "  âœ… æ‰©å±•æ‰“åŒ…æµ‹è¯•"
          echo "ğŸ† æµ‹è¯•è¦†ç›–èŒƒå›´ï¼š"
          echo "  â€¢ JavaScript/TypeScriptæ–‡ä»¶å¤„ç†"
          echo "  â€¢ React JSX/TSXç»„ä»¶å¤„ç†"
          echo "  â€¢ Vueå•æ–‡ä»¶ç»„ä»¶å¤„ç†"
          echo "  â€¢ ä¸­æ–‡å­—ç¬¦ä¸²è‡ªåŠ¨æ£€æµ‹"
          echo "  â€¢ i18nå‡½æ•°è°ƒç”¨è½¬æ¢"
          echo "  â€¢ é…ç½®æ–‡ä»¶æ ¼å¼éªŒè¯"
          echo "  â€¢ VS Codeæ‰©å±•æ‰“åŒ…"
          echo "ğŸš€ æ‰€æœ‰æµ‹è¯•å·²å®Œæˆï¼Œè¯·æŸ¥çœ‹å„æ­¥éª¤çš„è¯¦ç»†ç»“æœï¼"
